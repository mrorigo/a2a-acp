openapi: 3.0.1
info:
  title: A2A-ACP Public API
  version: 0.1.0
  description: |
    HTTP interface for the A2A-ACP gateway. The API exposes health checks,
    governance audit history, streaming utilities, OAuth authentication endpoints,
    development tool extension endpoints, and an A2A JSON-RPC bridge
    to governed Zed ACP agents.
servers:
  - url: https://api.example.com
    description: Production server (example)
  - url: http://localhost:8001
    description: Local development server
paths:
  /ping:
    get:
      summary: Lightweight health probe
      tags: [Observability]
      responses:
        '200':
          description: Service is reachable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PingResponse'
  /health:
    get:
      summary: Comprehensive health information
      tags: [Observability]
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Health snapshot
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
  /metrics/push-notifications:
    get:
      summary: Push notification delivery metrics
      tags: [Observability]
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Aggregated webhook metrics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PushNotificationMetrics'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
  /metrics/system:
    get:
      summary: System metrics and background task status
      tags: [Observability]
      security:
        - bearerAuth: []
      responses:
        '200':
          description: System metrics payload
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SystemMetrics'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
  /.well-known/agent-card.json:
    get:
      summary: Public A2A Agent Card
      tags: [Discovery]
      responses:
        '200':
          description: A2A Agent Card descriptor
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AgentCard'
        '500':
          description: Failed to generate agent card
  /a2a/rpc:
    post:
      summary: A2A JSON-RPC gateway
      description: >-
        Accepts JSON-RPC 2.0 requests for A2A operations (message/send,
        tasks/get, push notification configuration, etc.).
      tags: [A2A]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/JsonRpcRequest'
      responses:
        '200':
          description: JSON-RPC response payload
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JsonRpcResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
  /a2a/message/send:
    post:
      summary: Execute a single A2A task (non-streaming)
      tags: [A2A]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MessageSendRequest'
      responses:
        '200':
          description: Task result
          content:
            application/json:
              schema:
                type: object
                properties:
                  task:
                    $ref: '#/components/schemas/Task'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '502':
          description: Downstream agent error
  /a2a/message/stream:
    post:
      summary: Execute an A2A task with server-sent events
      tags: [A2A]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MessageSendRequest'
      responses:
        '200':
          description: Event stream containing task updates
          content:
            text/event-stream:
              schema:
                type: string
                description: Server-sent events stream
        '401':
          $ref: '#/components/responses/UnauthorizedError'
  /a2a/tasks/{task_id}/governor/history:
    get:
      summary: Governance decision history for a task
      tags: [Governance]
      security:
        - bearerAuth: []
      parameters:
        - name: task_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Aggregated permission and governor history
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GovernorHistoryResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          description: Task not found
  /streaming/sse:
    get:
      summary: Subscribe to task events via SSE
      tags: [Streaming]
      security:
        - bearerAuth: []
      parameters:
        - name: task_filter
          in: query
          required: false
          schema:
            type: string
            description: Comma-separated task identifiers to filter on
      responses:
        '200':
          description: Server-sent events stream
          content:
            text/event-stream:
              schema:
                type: string
        '401':
          $ref: '#/components/responses/UnauthorizedError'
  /streaming/stats:
    get:
      summary: Streaming connection statistics
      tags: [Streaming]
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Current connection counts and limits
          content:
            application/json:
              schema:
                type: object
                additionalProperties: true
        '401':
          $ref: '#/components/responses/UnauthorizedError'
  /streaming/cleanup:
    post:
      summary: Remove stale streaming connections
      tags: [Streaming]
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Cleanup summary
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StreamingCleanupResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  # WebSocket endpoint (OpenAPI 3.0.1 limitation - see components for details)
  /streaming/websocket:
    get:
      summary: WebSocket endpoint for real-time task notifications
      description: |
        WebSocket connection endpoint for receiving real-time task updates.
        Note: OpenAPI 3.0.1 has limited WebSocket support. This endpoint supports:
        - Connection establishment with Bearer token authentication
        - Optional task filtering via query parameter
        - Real-time task status updates, messages, and artifacts
      tags: [Streaming]
      security:
        - bearerAuth: []
      parameters:
        - name: task_filter
          in: query
          required: false
          schema:
            type: string
          description: Comma-separated task identifiers to filter notifications
      responses:
        '101':
          description: Switching Protocols - WebSocket handshake successful
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  # OAuth Authentication Endpoints
  /a2a/agents/{agent_id}/auth/start:
    post:
      summary: Start OAuth authentication flow
      tags: [OAuth]
      security:
        - bearerAuth: []
      parameters:
        - name: agent_id
          in: path
          required: true
          schema:
            type: string
          description: Agent identifier
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/StartRequest'
      responses:
        '200':
          description: Authorization URL and PKCE state generated
          content:
            application/json:
              schema:
                type: object
                properties:
                  authorize_url:
                    type: string
                  state:
                    type: string
                  expires_at:
                    type: integer
                    format: int64
                required: [authorize_url, state, expires_at]
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          description: OAuth flows disabled
        '409':
          description: Agent missing codex_home configuration
        '500':
          description: Internal server error

  /a2a/agents/{agent_id}/auth/callback:
    get:
      summary: OAuth callback endpoint
      tags: [OAuth]
      security:
        - bearerAuth: []
      parameters:
        - name: agent_id
          in: path
          required: true
          schema:
            type: string
          description: Agent identifier
        - name: code
          in: query
          required: true
          schema:
            type: string
          description: OAuth authorization code
        - name: state
          in: query
          required: true
          schema:
            type: string
          description: PKCE state parameter
      responses:
        '200':
          description: Authentication completed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  agent_id:
                    type: string
                  account_id:
                    type: string
                    nullable: true
                  expires:
                    type: integer
                    format: int64
                    nullable: true
                required: [success, agent_id]
        '400':
          description: Invalid request (missing code or state)
        '401':
          description: Unauthorized (invalid token exchange)
        '403':
          description: OAuth flows disabled
        '409':
          description: Agent missing codex_home configuration
        '502':
          description: Agent did not accept authentication token

  /a2a/agents/{agent_id}/auth/manual:
    post:
      summary: Manual OAuth callback for headless servers
      tags: [OAuth]
      security:
        - bearerAuth: []
      parameters:
        - name: agent_id
          in: path
          required: true
          schema:
            type: string
          description: Agent identifier
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ManualAuthRequest'
      responses:
        '200':
          description: Authentication completed via manual callback
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  agent_id:
                    type: string
                  account_id:
                    type: string
                    nullable: true
                  expires:
                    type: integer
                    format: int64
                    nullable: true
                required: [success, agent_id]
        '400':
          description: Invalid callback URL or missing parameters
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          description: OAuth flows disabled
        '409':
          description: Agent missing codex_home configuration
        '502':
          description: Agent did not accept authentication token

  /a2a/agents/{agent_id}/auth/status:
    get:
      summary: Check authentication status
      tags: [OAuth]
      security:
        - bearerAuth: []
      parameters:
        - name: agent_id
          in: path
          required: true
          schema:
            type: string
          description: Agent identifier
      responses:
        '200':
          description: Authentication status information
          content:
            application/json:
              schema:
                type: object
                properties:
                  signed_in:
                    type: boolean
                  expires:
                    type: integer
                    format: int64
                    nullable: true
                  account_id:
                    type: string
                    nullable: true
                  authentication_method:
                    type: string
                required: [signed_in, authentication_method]
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '409':
          description: Agent missing codex_home configuration

  /a2a/agents/{agent_id}/auth:
    delete:
      summary: Remove stored authentication token
      tags: [OAuth]
      security:
        - bearerAuth: []
      parameters:
        - name: agent_id
          in: path
          required: true
          schema:
            type: string
          description: Agent identifier
      responses:
        '204':
          description: Token successfully removed
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          description: No token found to delete
        '409':
          description: Agent missing codex_home configuration
        '500':
          description: Internal server error

  /a2a/agents/{agent_id}/auth/refresh:
    post:
      summary: Force token refresh
      tags: [OAuth]
      security:
        - bearerAuth: []
      parameters:
        - name: agent_id
          in: path
          required: true
          schema:
            type: string
          description: Agent identifier
      responses:
        '200':
          description: Token refresh completed
          content:
            application/json:
              schema:
                type: object
                properties:
                  agent_id:
                    type: string
                  expires:
                    type: integer
                    format: int64
                  created_at:
                    type: integer
                    format: int64
                required: [agent_id, expires]
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          description: OAuth flows disabled
        '409':
          description: Agent missing codex_home configuration

  /a2a/agents/{agent_id}/auth/check-auth:
    post:
      summary: Verify agent accepts current authentication token
      tags: [OAuth]
      security:
        - bearerAuth: []
      parameters:
        - name: agent_id
          in: path
          required: true
          schema:
            type: string
          description: Agent identifier
      responses:
        '200':
          description: Agent accepts the authentication token
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  agent_id:
                    type: string
                required: [success, agent_id]
        '401':
          description: Token missing or agent rejected authentication
        '409':
          description: Agent missing codex_home configuration
        '500':
          description: Internal server error

  # Development Tool Extension Endpoints
  /a2a/commands/get:
    get:
      summary: Get all available slash commands
      tags: [Development Tools]
      security:
        - bearerAuth: []
      responses:
        '200':
          description: List of available slash commands
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GetAllSlashCommandsResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          description: Development tool extension not enabled

  /a2a/command/execute:
    post:
      summary: Execute a slash command
      tags: [Development Tools]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ExecuteSlashCommandRequest'
      responses:
        '200':
          description: Command execution started
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExecuteSlashCommandResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          description: Development tool extension not enabled
        '422':
          description: Validation error (missing required arguments, invalid command)
        '500':
          description: Internal server error

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  responses:
    UnauthorizedError:
      description: Missing or invalid authorization token
      content:
        application/json:
          schema:
            type: object
            properties:
              detail:
                type: string
  schemas:
    PingResponse:
      type: object
      properties:
        status:
          type: string
          example: ok
      required: [status]
    HealthResponse:
      type: object
      properties:
        status:
          type: string
        timestamp:
          type: string
          format: date-time
        services:
          type: object
          properties:
            database:
              type: string
            push_notifications:
              type: string
            streaming:
              type: string
        version:
          type: string
      required: [status, timestamp, services]
    PushNotificationMetrics:
      type: object
      properties:
        timestamp:
          type: string
          format: date-time
        delivery_stats:
          type: object
          properties:
            total_deliveries:
              type: integer
            successful_deliveries:
              type: integer
            failed_deliveries:
              type: integer
            success_rate:
              type: number
              format: float
        configuration_stats:
          type: object
          properties:
            total_configs:
              type: integer
            active_configs:
              type: integer
            expired_configs:
              type: integer
        performance_stats:
          type: object
          properties:
            average_response_time:
              type: number
              description: Average webhook response time in milliseconds.
            requests_per_minute:
              type: number
            error_rate:
              type: number
        error:
          type: string
      required: [timestamp, delivery_stats, configuration_stats, performance_stats]
    SystemMetrics:
      type: object
      properties:
        timestamp:
          type: string
          format: date-time
        streaming_connections:
          type: object
          properties:
            websocket:
              $ref: '#/components/schemas/ConnectionMetrics'
            sse:
              $ref: '#/components/schemas/ConnectionMetrics'
        push_notifications:
          type: object
          properties:
            queue_depth:
              type: integer
            retry_pending:
              type: integer
            last_delivery:
              type: string
              format: date-time
        background_tasks:
          type: object
          properties:
            cleanup_running:
              type: boolean
        error:
          type: string
      required: [timestamp]
    ConnectionMetrics:
      type: object
      properties:
        active:
          type: integer
        limit:
          type: integer
        stale:
          type: integer
      required: [active]
    AgentCard:
      type: object
      properties:
        protocolVersion:
          type: string
        name:
          type: string
        description:
          type: string
        url:
          type: string
          format: uri
        preferredTransport:
          type: string
        capabilities:
          type: object
          description: Declares runtime capabilities exposed by the agent.
          properties:
            streaming:
              type: boolean
            pushNotifications:
              type: boolean
            stateTransitionHistory:
              type: boolean
            extensions:
              type: array
              items:
                type: object
                properties:
                  uri:
                    type: string
                  params:
                    type: object
                    properties:
                      version:
                        type: string
                      metadata:
                        type: object
                        properties:
                          description:
                            type: string
            websocket:
              type: boolean
              description: WebSocket streaming support
          additionalProperties:
            type: boolean
        skills:
          type: array
          items:
            $ref: '#/components/schemas/AgentSkill'
      required: [protocolVersion, name, description, url, capabilities, skills]
    AgentSkill:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        description:
          type: string
        tags:
          type: array
          items:
            type: string
        examples:
          type: array
          items:
            type: string
      required: [id, name, description, tags]
    JsonRpcRequest:
      type: object
      properties:
        jsonrpc:
          type: string
          enum: ["2.0"]
        id:
          oneOf:
            - type: string
            - type: integer
          nullable: true
        method:
          type: string
        params:
          type: object
          description: Method-specific parameters; structure depends on the target JSON-RPC method.
          additionalProperties: true
      required: [jsonrpc, method]
    JsonRpcResponse:
      type: object
      properties:
        jsonrpc:
          type: string
          enum: ["2.0"]
        id:
          oneOf:
            - type: string
            - type: integer
          nullable: true
        result:
          type: object
          description: Method-specific result payload returned by the downstream agent.
          additionalProperties: true
        error:
          type: object
          properties:
            code:
              type: integer
            message:
              type: string
            data:
              type: object
              description: Optional structured error context supplied by the agent.
              additionalProperties: true
      required: [jsonrpc]
    MessageSendRequest:
      type: object
      properties:
        message:
          $ref: '#/components/schemas/AgentMessage'
        metadata:
          type: object
          additionalProperties: true
      required: [message]
    AgentMessage:
      type: object
      properties:
        role:
          type: string
          enum: [user, agent]
        parts:
          type: array
          items:
            $ref: '#/components/schemas/MessagePart'
        messageId:
          type: string
        contextId:
          type: string
        metadata:
          type: object
          additionalProperties: true
      required: [role, parts, messageId]
    MessagePart:
      type: object
      properties:
        kind:
          type: string
          enum: [text, file, data]
        text:
          type: string
        file:
          type: object
          additionalProperties: true
        data:
          type: object
          additionalProperties: true
      required: [kind]
    Task:
      type: object
      properties:
        id:
          type: string
        contextId:
          type: string
        status:
          $ref: '#/components/schemas/TaskStatus'
        history:
          type: array
          items:
            $ref: '#/components/schemas/AgentMessage'
        artifacts:
          type: array
          items:
            type: object
            additionalProperties: true
        metadata:
          type: object
          additionalProperties: true
      required: [id, contextId, status]
    TaskStatus:
      type: object
      properties:
        state:
          type: string
        timestamp:
          type: string
          format: date-time
        message:
          $ref: '#/components/schemas/AgentMessage'
      required: [state]
    GovernorHistoryResponse:
      type: object
      properties:
        permissionDecisions:
          type: array
          items:
            $ref: '#/components/schemas/PermissionDecisionEntry'
        pendingPermissions:
          type: array
          items:
            $ref: '#/components/schemas/PendingPermissionEntry'
        governorFeedback:
          type: array
          items:
            $ref: '#/components/schemas/GovernorFeedbackEntry'
      required: [permissionDecisions, pendingPermissions, governorFeedback]
    PermissionDecisionEntry:
      type: object
      properties:
        toolCallId:
          type: string
        source:
          type: string
          description: Origin of the decision (policy:<id>, governor:<id>, user).
        optionId:
          type: string
        governorsInvolved:
          type: array
          items:
            type: string
        timestamp:
          type: string
          format: date-time
        metadata:
          type: object
          description: Additional decision context (diff summaries, policy rationale).
          additionalProperties: true
      required: [toolCallId, source, optionId, timestamp]
    PendingPermissionEntry:
      type: object
      properties:
        toolCallId:
          type: string
        toolCall:
          type: object
          description: Original tool call payload awaiting approval.
          additionalProperties: true
        options:
          type: array
          items:
            type: object
            properties:
              optionId:
                type: string
              name:
                type: string
              kind:
                type: string
            required: [optionId, kind]
        summary:
          type: array
          items:
            type: string
        created_at:
          type: string
          format: date-time
      required: [toolCallId, toolCall, options, created_at]
    GovernorFeedbackEntry:
      type: object
      properties:
        phase:
          type: string
          description: Permission or post_run phase indicator.
        timestamp:
          type: string
          format: date-time
        summary:
          type: array
          items:
            type: string
        results:
          type: array
          items:
            $ref: '#/components/schemas/GovernorResultEntry'
      required: [phase, timestamp, results]
    GovernorResultEntry:
      type: object
      properties:
        governorId:
          type: string
        status:
          type: string
        optionId:
          type: string
        score:
          type: number
        messages:
          type: array
          items:
            type: string
        followUpPrompt:
          type: string
        metadata:
          type: object
          description: Governor-specific structured data.
          additionalProperties: true
      required: [governorId, status]
    StreamingCleanupResponse:
      type: object
      properties:
        success:
          type: boolean
        cleaned_connections:
          type: integer
        message:
          type: string
      required: [success, cleaned_connections]

    # OAuth Request/Response Schemas
    StartRequest:
      type: object
      properties:
        client_id:
          type: string
          nullable: true
          description: Optional OAuth client ID
        redirect_uri:
          type: string
          nullable: true
          description: Optional redirect URI
        scope:
          type: string
          nullable: true
          description: Optional OAuth scope
      additionalProperties: false

    ManualAuthRequest:
      type: object
      properties:
        callback_url:
          type: string
          description: Full callback URL containing code and state parameters
        state:
          type: string
          nullable: true
          description: Optional state parameter
      required: [callback_url]

    # Development Tool Extension Schemas
    SlashCommandArgument:
      type: object
      properties:
        name:
          type: string
          description: Argument name
        type:
          type: string
          description: Argument type (e.g., "string", "number")
        description:
          type: string
          description: Argument description
        required:
          type: boolean
          description: Whether the argument is required
      required: [name, type, description]

    SlashCommand:
      type: object
      properties:
        name:
          type: string
          description: Command name
        description:
          type: string
          description: Command description
        arguments:
          type: array
          items:
            $ref: '#/components/schemas/SlashCommandArgument'
          description: List of command arguments
      required: [name, description]

    GetAllSlashCommandsResponse:
      type: object
      properties:
        commands:
          type: array
          items:
            $ref: '#/components/schemas/SlashCommand'
          description: List of available slash commands
      required: [commands]

    ExecuteSlashCommandRequest:
      type: object
      properties:
        command:
          type: string
          description: Name of the command to execute
        arguments:
          type: object
          description: Command arguments as key-value pairs
          additionalProperties: true
      required: [command]

    ExecuteSlashCommandResponse:
      type: object
      properties:
        execution_id:
          type: string
          description: Unique identifier for the command execution (matches task ID)
        status:
          type: string
          enum: [pending, executing, completed, failed]
          description: Current execution status
      required: [execution_id, status]
